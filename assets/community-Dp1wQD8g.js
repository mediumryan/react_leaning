import{t as e,b as h,w as B,A as I}from"./index-Djl51xko.js";import{B as j,b as S,h as T,s as E,L as w,v as U,t as M,w as z,x as H,y as O,r as R,z as $,A as G,C as W,D as V,E as Y,F as q}from"./label-DahRaslS.js";import{D as X,b as Z,c as J,d as K}from"./dialog-CZA1q8pS.js";import{c as Q,t as L}from"./index-DE4h2VEI.js";import{B as ee}from"./BackgroundSpinner-BmPeNkxa.js";import{B as te}from"./button-group-Sq6WdPxg.js";import{u as v}from"./useTranslation--5zCHKf_.js";import{P as se,T as ae}from"./textarea-BZaXx_cY.js";import{d as ne,C as oe,a as ie,b as re,c as ce}from"./card-DP1A_csb.js";import{B as P}from"./badge-DWtvmZof.js";import{C as le}from"./ConfirmDialog-jIALXBh6.js";import{b as F,u as me,a as D}from"./react-C6GO0r9T.js";import{I as A}from"./input-BbUSEJaE.js";const de=[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5",key:"mvr1a0"}]],ue=Q("heart",de),xe=({postOrder:t,setPostOrder:r,setEditingPost:d,setShowForm:s})=>{const{t:n}=v();return e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs(te,{className:"gap-0.5",children:[e.jsx(j,{onClick:()=>r("new"),variant:t==="new"?"default":"secondary",children:n("community.community_button_new")}),e.jsx(j,{onClick:()=>r("popular"),variant:t==="popular"?"default":"secondary",children:n("community.community_button_popular")})]}),e.jsxs(j,{className:"flex items-center gap-2",onClick:()=>{d(null),s(!0)},children:[e.jsx(se,{className:"w-4 h-4"}),n("community.community_button_add_post")]})]})},he=({post:t,setEditingPost:r,setShowForm:d,handleClickLikeButton:s,handleDelete:n,isNewPost:p})=>{const{t:m}=v(),a=F(S),[u,y]=h.useState(!1),x=_=>{s(_),y(!0),setTimeout(()=>y(!1),300)};return e.jsxs(e.Fragment,{children:[e.jsxs(ne,{className:"flex justify-between",children:[e.jsxs(j,{variant:"ghost",size:"sm",className:"flex items-center gap-1",onClick:()=>x(t),children:[e.jsx(ue,{className:`w-4 h-4 ${u?"animate-ping":""}`,fill:t.isLiked?"red":"none"}),t.likeCount]}),(a?.authority==="admin"||a?.authority==="instructor"||a?.uid===t.userId)&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{variant:"secondary",size:"sm",onClick:()=>{r(t),d(!0)},children:m("common.edit")}),e.jsx(le,{buttonLabel:m("common.delete"),triggerVariant:"destructive",triggerDisabled:!1,triggerSize:"sm",title:m("community.community_post_delete_confirm"),titleWithIcon:"warning",cancleButtonLabel:m("common.cancel"),confirmButtonLabel:m("common.delete"),onConfirm:()=>n(t)})]})]}),p(t)&&e.jsx(P,{className:"absolute top-0 left-0 animate-bounce",children:"New"})]})},pe=({posts:t,handleClickLikeButton:r,handleDelete:d,setEditingPost:s,setShowForm:n,isNewPost:p})=>{const{t:m}=v();return e.jsx(e.Fragment,{children:t.map(a=>e.jsxs(oe,{className:"shadow-sm relative",children:[e.jsx(ie,{children:e.jsxs(re,{className:"text-lg flex justify-between items-center",children:[e.jsx("span",{children:a.title}),e.jsxs("div",{className:"text-sm flex flex-col items-end space-y-0.5",children:[e.jsx("span",{children:a.name}),e.jsx("span",{children:a.createdAt.toLocaleDateString()})]})]})}),e.jsxs(ce,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:a.content}),a.projectLink&&e.jsx("a",{href:a.projectLink,target:"_blank",className:"text-sm text-blue-600 underline font-bold italic",children:m("community.community_post_link")}),a.imageUrl&&e.jsx("div",{className:"aspect-video overflow-hidden rounded-md",children:e.jsx("img",{src:a.imageUrl,alt:"",className:"h-full w-full object-cover"})})]}),e.jsx(he,{post:a,setEditingPost:s,setShowForm:n,handleClickLikeButton:r,handleDelete:d,isNewPost:p})]},a.id))})},fe=T({open:!1,options:{message:"",icon:0,size:"sm"}}),je=E();function ye(t){return new Promise(r=>{je.set(fe,{open:!0,options:t,resolver:r})})}const ge=.5,_e=["jpeg","png","webp"],C="text-blue-500 mb-4",ve=({editPost:t,onClose:r,onSave:d})=>{const{t:s}=v(),[n,p]=h.useState(t?.title||""),[m,a]=h.useState(t?.content||""),[u,y]=h.useState(t?.projectLink||""),[x,_]=h.useState(null),g=F(S),b=async()=>{if(!n.trim()){L.error(s("community.community_post_add_title_required"));return}let o;if(x){const f=M(z,`posts/${Date.now()}_${x.name}`);await H(f,x),o=await O(f)}else o=null;d({title:n,content:m,projectLink:u,imageUrl:o,name:g?.nickname||"Anonymous",userId:g?.uid||"Anonymous"}),r()},k=async o=>{const f=o.target.files?.[0];if(!f)return;const c=U(f);if(c){await ye({icon:0,message:c,size:"sm"}),o.target.value="";return}_(f)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(w,{htmlFor:"title",className:C,children:s("community.community_post_add_title_label")}),e.jsx(A,{id:"title",placeholder:s("community.community_post_add_title_placeholder"),value:n,onChange:o=>p(o.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(w,{htmlFor:"content",className:C,children:s("community.community_post_add_content_label")}),e.jsx(ae,{id:"content",placeholder:s("community.community_post_add_content_placeholder"),value:m,onChange:o=>a(o.target.value),rows:4})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(w,{htmlFor:"projectLink",className:C,children:s("community.community_post_add_link_label")}),e.jsx(A,{id:"projectLink",placeholder:"https://example.com",value:u,onChange:o=>y(o.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"image",className:C,children:s("community.community_post_add_preview_label")}),e.jsx(A,{id:"image",type:"file",accept:"image/jpeg,image/png,image/webp",onChange:k}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-sm text-muted-foreground",children:[e.jsxs("span",{children:[s("community.community_post_add_upload_limit_label"),":"]}),e.jsxs(P,{variant:"secondary",children:[ge,"MB"," ",s("community.community_post_add_upload_limit_mb")]}),_e.map(o=>e.jsx(P,{variant:"outline",children:o},o))]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx(j,{variant:"outline",onClick:r,children:s("common.cancel")}),e.jsx(j,{onClick:b,children:s(t?"common.edit":"common.upload")})]})]})};function we(){const t=F(S),r=me(R),[d,s]=h.useState([]),[n,p]=h.useState(null),[m,a]=h.useState(!1),[u,y]=D($),[{data:x,isPending:_}]=D(G),{t:g}=v();h.useEffect(()=>{if(!x)return;(async()=>{await Promise.resolve();let i=[...x];u==="new"?i.sort((l,N)=>N.createdAt.getTime()-l.createdAt.getTime()):u==="popular"&&i.sort((l,N)=>N.likeCount-l.likeCount),s(i)})()},[x,u]);const b=async c=>{try{await W(c),r(i=>i+1),L.success("ポストが削除されました")}catch(i){console.error("Failed to delete post:",i)}},k=async c=>{n?await Y(n.id,n,c):await q(c,c.userId||"Anonymous"),r(i=>i+1),L.success(`ポストが${n?"更新":"作成"}されました`)},o=c=>{const i=new Date;return i.setDate(i.getDate()-7),c.createdAt>=i},f=async c=>{if(t){s(i=>i.map(l=>l.id===c.id?{...l,likeCount:l.isLiked?l.likeCount-1:l.likeCount+1,isLiked:!l.isLiked}:l));try{await V(c.id,t.uid)}catch(i){console.error("Like update failed, reverting:",i),r(l=>l+1)}}};return _?e.jsx(ee,{}):t?e.jsxs("div",{className:"min-h-screen w-full bg-muted/40",children:[e.jsx("div",{className:"flex justify-center",children:e.jsxs("main",{className:"w-full max-w-xl md:max-w-2xl px-4 py-10 space-y-10",children:[e.jsx(xe,{postOrder:u,setPostOrder:y,setEditingPost:p,setShowForm:a}),e.jsx(pe,{posts:d,handleClickLikeButton:f,handleDelete:b,setEditingPost:p,setShowForm:a,isNewPost:o})]})}),e.jsx(X,{open:m,onOpenChange:a,children:e.jsxs(Z,{"aria-describedby":g("community.community_post_add_label"),children:[e.jsx(J,{children:e.jsx(K,{children:g(n?"community.community_post_edit_label":"community.community_post_add_label")})}),e.jsx(ve,{editPost:n,onClose:()=>a(!1),onSave:k})]})})]}):e.jsx(I,{to:"/login",replace:!0})}const Ee=B(function(){return e.jsx(we,{})});export{Ee as default};
