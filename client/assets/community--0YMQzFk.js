import{a as o,p as e,w as B,y as F}from"./chunk-EPOLDU6W-K4piUF01.js";import{f as b,e as D,B as l,r as I,o as E,p as _,q as T,h as U,d as S}from"./button-CAZCDkQr.js";import{v as z,r as M,p as O,j as R,l as G,k as H,u as W,n as $}from"./helper-qGNXvysJ.js";import{C as q,a as V,b as X,c as Y,d as Z}from"./card-gxypV0ip.js";import{B as L,P as J,D as K,b as Q,c as ee,d as se}from"./dialog-oaqZQNbR.js";import{B as te}from"./button-group-BUyBRTz3.js";import{L as v,I as N}from"./input-Dkyvn_pA.js";import{T as ae,c as A}from"./confirm-Dr8fUyKG.js";import{B as ne}from"./BackgroundSpinner-C8qNac8V.js";import{c as ie}from"./index-mZfcMAy8.js";import"./x-B083jXCI.js";import"./index-HXCuKcVE.js";const re=[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5",key:"mvr1a0"}]],le=ie("heart",re),oe=.5,ce=["jpeg","png","webp"];function de({editPost:i,onClose:u,onSave:w}){const[x,c]=o.useState(i?.title||""),[j,k]=o.useState(i?.content||""),[d,m]=o.useState(i?.projectLink||""),[h,f]=o.useState(null),g=b(D),P=async()=>{if(!x.trim()){await A({icon:0,message:"タイトルを入力してください。",size:"sm"});return}let t;if(h){const r=I(E,`posts/${Date.now()}_${h.name}`);await _(r,h),t=await T(r)}else t=null;w({title:x,content:j,projectLink:d,imageUrl:t,name:g?.nickname||"Anonymous",userId:g?.uid||"Anonymous"}),u()},y=async t=>{const r=t.target.files?.[0];if(!r)return;const p=z(r);if(p){await A({icon:0,message:p,size:"sm"}),t.target.value="";return}f(r)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(v,{htmlFor:"title",children:"タイトル"}),e.jsx(N,{id:"title",placeholder:"タイトルを入力してください",value:x,onChange:t=>c(t.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(v,{htmlFor:"content",children:"内容"}),e.jsx(ae,{id:"content",placeholder:"内容を入力してください",value:j,onChange:t=>k(t.target.value),rows:4})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(v,{htmlFor:"projectLink",children:"プロジェクトリンク"}),e.jsx(N,{id:"projectLink",placeholder:"https://",value:d,onChange:t=>m(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"image",children:"プレビューイメージ"}),e.jsx(N,{id:"image",type:"file",accept:"image/jpeg,image/png,image/webp",onChange:y}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("span",{children:"アップロード制限:"}),e.jsxs(L,{variant:"secondary",children:[oe,"MB 以下"]}),ce.map(t=>e.jsx(L,{variant:"outline",children:t},t))]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx(l,{variant:"outline",onClick:u,children:"キャンセル"}),e.jsx(l,{onClick:P,children:i?"修正":"保存"})]})]})}function me(){const i=b(D),u=U(M),[w,x]=o.useState([]),[c,j]=o.useState(null),[k,d]=o.useState(!1),[m,h]=S(O),[{data:f,isPending:g,isError:P}]=S(R);o.useEffect(()=>{if(!f)return;(async()=>{await Promise.resolve();let a=[...f];m==="new"?(a.sort((n,C)=>C.createdAt.getTime()-n.createdAt.getTime()),console.log("Sorted by new:",a)):m==="popular"&&a.sort((n,C)=>C.likeCount-n.likeCount),x(a)})()},[f,m]);const y=async s=>{await A({icon:1,message:"削除しますか？",size:"sm"})&&(await H(s),u(n=>n+1))},t=async s=>{c?await W(c.id,c,s):await $(s,s.userId||"Anonymous"),u(a=>a+1)},r=s=>{const a=new Date;return a.setDate(a.getDate()-7),s.createdAt>=a},p=async s=>{if(i){x(a=>a.map(n=>n.id===s.id?{...n,likeCount:n.isLiked?n.likeCount-1:n.likeCount+1,isLiked:!n.isLiked}:n));try{await G(s.id,i.uid)}catch(a){console.error("Like update failed, reverting:",a),u(n=>n+1)}}};return g?e.jsx(ne,{}):i?e.jsxs("div",{className:"min-h-screen w-full bg-muted/40",children:[e.jsx("div",{className:"flex justify-center",children:e.jsxs("main",{className:"w-full max-w-xl md:max-w-2xl px-4 py-10 space-y-10",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs(te,{className:"gap-0.5",children:[e.jsx(l,{onClick:()=>h("new"),variant:m==="new"?"default":"secondary",children:"最新"}),e.jsx(l,{onClick:()=>h("popular"),variant:m==="popular"?"default":"secondary",children:"人気"})]}),e.jsxs(l,{className:"flex items-center gap-2",onClick:()=>{j(null),d(!0)},children:[e.jsx(J,{className:"w-4 h-4"}),"ポスト作成"]})]}),w.map(s=>e.jsxs(q,{className:"shadow-sm relative",children:[e.jsx(V,{children:e.jsxs(X,{className:"text-lg flex justify-between items-center",children:[e.jsx("span",{children:s.title}),e.jsxs("div",{className:"text-sm flex flex-col items-end space-y-0.5",children:[e.jsx("span",{children:s.name}),e.jsx("span",{children:s.createdAt.toLocaleDateString()})]})]})}),e.jsxs(Y,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:s.content}),s.projectLink&&e.jsx("a",{href:s.projectLink,target:"_blank",className:"text-sm text-blue-600 underline",children:"プロジェクトリンク"}),s.imageUrl&&e.jsx("div",{className:"aspect-video overflow-hidden rounded-md",children:e.jsx("img",{src:s.imageUrl,alt:"",className:"h-full w-full object-cover"})})]}),e.jsxs(Z,{className:"flex justify-between",children:[e.jsxs(l,{variant:"ghost",size:"sm",className:"flex items-center gap-1",onClick:()=>p(s),children:[e.jsx(le,{className:"w-4 h-4",fill:s.isLiked?"red":"none"}),s.likeCount]}),(i.authority==="admin"||i.authority==="instructor"||i.uid===s.userId)&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(l,{variant:"secondary",size:"sm",onClick:()=>{j(s),d(!0)},children:"修正"}),e.jsx(l,{variant:"destructive",size:"sm",onClick:()=>y(s),children:"削除"})]})]}),r(s)&&e.jsx(L,{className:"absolute top-0 left-0 animate-bounce",children:"New"})]},s.id))]})}),e.jsx(K,{open:k,onOpenChange:d,children:e.jsxs(Q,{children:[e.jsx(ee,{children:e.jsx(se,{children:c?"ポスト修正":"ポスト作成"})}),e.jsx(de,{editPost:c,onClose:()=>d(!1),onSave:t})]})})]}):e.jsx(F,{to:"/login",replace:!0})}const Ne=B(function(){return e.jsx(me,{})});export{Ne as default};
